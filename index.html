<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Think Nube - Entrevista AI</title>
    <!-- (mantiene los estilos anteriores sin cambios) -->
</head>
<body>
    <!-- ... (HTML visual igual al anterior) ... -->

    <script>
        // Obtener parámetros desde la URL
        const params = new URLSearchParams(window.location.search);
        const descripcion = params.get('descripcion') || 'Tema general';
        const sessionID = params.get('sessionID') || '';
        const estudioID = params.get('ID') || '';

        // Actualizar texto visible
        const descripcionTexto = document.getElementById('descripcionTexto');
        if (descripcionTexto) descripcionTexto.textContent = descripcion;

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const welcomeScreen = document.getElementById('welcomeScreen');

        const webhookUrl = 'https://agentsol.app.n8n.cloud/webhook/716ddad8-70a4-4679-8c5f-d914a53dce84/chat';

        function addMessage(text, isUser = false, isError = false) {
            if (welcomeScreen) welcomeScreen.classList.add('hide-welcome');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : (isError ? 'error' : 'assistant')}`;
            const avatarText = isUser ? 'TÚ' : (isError ? '⚠️' : 'AI');
            const avatarClass = isUser ? 'user' : (isError ? 'error' : 'assistant');

            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="avatar ${avatarClass}">${avatarText}</div>
                    <div class="message-text">${text}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        async function postToWebhook(mensaje) {
            showTypingIndicator();

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        mensaje: mensaje,
                        timestamp: new Date().toISOString(),
                        descripcion: descripcion,
                        sessionID: sessionID,
                        estudioID: estudioID
                    })
                });

                hideTypingIndicator();

                if (response.ok) {
                    const data = await response.text();
                    addMessage(data || 'Respuesta recibida correctamente', false);
                } else {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage(`Error de conexión: ${error.message}`, false, true);
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendButton.disabled = true;

            await postToWebhook(message);

            sendButton.disabled = false;
            messageInput.focus();
        }

        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const bienvenida = `¡Perfecto! Comencemos con la entrevista sobre "${descripcion}". ¿Podrías contarme un poco sobre tu experiencia en este campo?`;
                addMessage(bienvenida, false);
                postToWebhook(`Inicio de entrevista: ${descripcion}`);
                messageInput.focus();
            }, 1000);
        });
    </script>
</body>
</html>
